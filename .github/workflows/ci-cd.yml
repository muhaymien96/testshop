name: Build & Publish Docker images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE_NAME: testshop-backend
  FRONTEND_IMAGE_NAME: testshop-frontend

jobs:
  build-and-publish:
    name: Build Docker images and push to GHCR (and optionally Docker Hub)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/Dockerfile.backend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}

      - name: Build and push frontend image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/Dockerfile.frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}

      - name: Optionally push images to Docker Hub
        if: secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != ''
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "Logging in to Docker Hub as $DH_USER"
          echo $DH_TOKEN | docker login --username $DH_USER --password-stdin
          docker tag ghcr.io/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE_NAME }}:latest $DH_USER/${{ env.BACKEND_IMAGE_NAME }}:latest
          docker tag ghcr.io/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:latest $DH_USER/${{ env.FRONTEND_IMAGE_NAME }}:latest
          docker push $DH_USER/${{ env.BACKEND_IMAGE_NAME }}:latest
          docker push $DH_USER/${{ env.FRONTEND_IMAGE_NAME }}:latest

      - name: Output image locations
        run: |
          echo "GHCR backend: ghcr.io/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE_NAME }}:latest"
          echo "GHCR frontend: ghcr.io/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then echo "Docker Hub images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:latest and ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"; fi

  deploy:
    name: Deploy to remote server via SSH
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: secrets.SSH_PRIVATE_KEY != '' && secrets.SSH_HOST != '' && secrets.SSH_USER != ''
    steps:
      - name: Determine image sources
        id: imgs
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "BACKEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
            echo "FRONTEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          else
            echo "BACKEND_IMAGE=ghcr.io/${{ github.repository_owner }}/${{ env.BACKEND_IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
            echo "FRONTEND_IMAGE=ghcr.io/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e
            echo "Pulling backend image: ${{ steps.imgs.outputs.BACKEND_IMAGE }}"
            # Login to Docker registry if using Docker Hub
            if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
              echo "Logging in to Docker Hub..."
              echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            else
              echo "Logging in to GHCR..."
              echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin || true
            fi

            docker pull ${{ steps.imgs.outputs.BACKEND_IMAGE }}
            docker pull ${{ steps.imgs.outputs.FRONTEND_IMAGE }}

            docker stop testapp-backend || true
            docker rm testapp-backend || true
            docker run -d --restart unless-stopped --name testapp-backend -p 3001:3001 ${{ steps.imgs.outputs.BACKEND_IMAGE }}

            docker stop testapp-frontend || true
            docker rm testapp-frontend || true
            docker run -d --restart unless-stopped --name testapp-frontend -p 3000:3000 ${{ steps.imgs.outputs.FRONTEND_IMAGE }}

            echo "Deploy complete"
